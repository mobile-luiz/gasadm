<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de G√°s | Admin - E-commerce View</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* --- ESTILOS GLOBAIS E DE LAYOUT --- */
        :root {
            --primary-color: #ff5722; /* Laranja E-commerce/Delivery */
            --secondary-color: #4a4e69; /* Cinza Escuro Moderno */
            --success-color: #4caf50; 
            --danger-color: #f44336; 
            --warning-color: #ff9800; /* Amarelo Laranja */
            --info-color: #03a9f4; /* Azul para "A Caminho" */
            --bg-light: #f5f5f5; 
            --text-dark: #2c2c2c; 
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-light);
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh; 
            margin: 0; 
            color: var(--text-dark);
            padding: 20px 0;
        }
        h1, h2 { font-weight: 600; color: var(--primary-color); }
        .main-container {
            width: 98%; 
            max-width: 1400px;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* --- LOGIN --- */
        .login-container { max-width: 400px; margin: 100px auto; padding: 40px; border: 1px solid #ddd; border-radius: 10px; text-align: center; box-shadow: var(--card-shadow); }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; text-align: left; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        button { 
            padding: 12px 15px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: background-color 0.3s, transform 0.1s; 
            font-size: 1rem; 
        }
        button:hover:not(:disabled) { background-color: #e64a19; transform: translateY(-1px); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        
        /* --- DASHBOARD HEADER --- */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .main-controls-group { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .user-info { font-weight: 500; color: var(--secondary-color); font-size: 0.95rem;}
        #logoutBtn { background-color: var(--secondary-color); width: auto; margin: 0; padding: 8px 15px; }

        /* Estilo para Bot√µes de A√ß√£o R√°pida (√çcones) - DISCRETO */
        .quick-actions { 
            display: flex; 
            gap: 5px; 
            align-items: center;
        }
        .icon-btn {
            width: 40px; 
            height: 40px;
            padding: 0;
            margin: 0;
            background-color: var(--secondary-color);
            border-radius: 50%; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            text-decoration: none;
            border: none;
            cursor: pointer;
        }
        .icon-btn#reportsLink { background-color: var(--success-color); }
        .icon-btn#priceBtn { background-color: var(--secondary-color); }
        .icon-btn:hover { transform: scale(1.05); } 

        /* --- CARDS DE ESTAT√çSTICAS --- */
        .stats-cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: var(--card-shadow); 
            background-color: #fff; 
            border-left: 5px solid var(--primary-color);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card h3 { margin-top: 0; font-size: 0.9rem; color: var(--secondary-color); font-weight: 500; }
        .stat-card p { font-size: 2.2rem; font-weight: 700; margin: 5px 0 0; }
        
        .stat-card.pendente { border-left-color: var(--warning-color); }
        .stat-card.a-caminho { border-left-color: var(--info-color); }
        .stat-card.concluido { border-left-color: var(--success-color); }
        .stat-card.cancelado { border-left-color: var(--danger-color); }

        /* --- CONTROLES E FILTROS --- */
        .dashboard-controls { 
            display: flex; 
            justify-content: flex-start; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 20px; 
            margin-bottom: 25px; 
            padding: 15px; 
            background-color: #fce4ec; 
            border-radius: 8px;
        }

        .filter-controls { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-controls button { 
            width: auto; 
            margin: 0; 
            padding: 10px 18px; 
            font-size: 0.9rem; 
            background-color: var(--secondary-color);
            transition: background-color 0.3s;
        }
        .filter-controls .active-filter { 
            background-color: var(--primary-color) !important; 
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* --- GRADE DE PEDIDOS (E-COMMERCE VIEW) --- */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
            gap: 25px;
            padding-top: 10px;
        }

        .pedido-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-top: 5px solid var(--primary-color);
            transition: box-shadow 0.3s, transform 0.2s;
            position: relative;
        }
        .pedido-card:hover { box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); transform: translateY(-2px); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        /* Badges de Status no Card */
        .status { 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-weight: 600; 
            font-size: 0.8rem; 
            min-width: 90px; 
            text-align: center;
        }
        .status-Pendente { background-color: #fff3cd; color: #856404; }
        .status-ACaminho { background-color: #e1f5fe; color: #0288d1; }
        .status-Concluido { background-color: #e8f5e9; color: #2e7d32; }
        .status-Cancelado { background-color: #ffebee; color: #c62828; }

        .card-body p { margin: 8px 0; font-size: 0.9rem; }
        .card-body strong { color: var(--primary-color); font-weight: 600; display: inline-block; min-width: 80px; }
        
        /* Ajuste do Client Info para comportar o WhatsApp */
        .client-info { 
            font-size: 0.95rem; 
            font-weight: 500; 
            color: var(--text-dark); 
            margin-bottom: 10px; 
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .client-info p { margin: 5px 0; }
        .client-info strong { color: var(--secondary-color); font-weight: 600; }
        
        .address-detail {
            border-top: 1px dashed #ddd;
            padding-top: 10px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        /* AJUSTE PARA O NOVO BOT√ÉO R√ÅPIDO */
        .action-container {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            display: flex; /* Habilita layout lado a lado */
            justify-content: space-between; 
            align-items: center;
        }
        
        /* Garante que o bot√£o r√°pido ocupe metade do espa√ßo */
        .action-container button:not(.dropbtn):not([disabled]) { 
            width: calc(50% - 5px); 
            margin-right: 10px;
        }
        
        /* Ajuste de largura para o dropdown quando h√° outro bot√£o */
        .dropdown { position: relative; display: inline-block; width: calc(50% - 5px); }
        .dropbtn { 
            background-color: var(--primary-color); 
            padding: 10px 15px; 
            font-size: 0.9rem; 
            border-radius: 6px; 
            width: 100%;
        }
        .dropdown-content { 
            display: none; 
            position: absolute; 
            min-width: 100%; 
            box-shadow: var(--card-shadow); 
            z-index: 10;
            background-color: #fff;
            border-radius: 6px;
            overflow: hidden;
            top: 100%; 
            left: 0;
            margin-top: 5px;
        }
        .dropdown-content.show-dropdown { display: block; }
        .dropdown-content button {
            color: var(--text-dark);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .dropdown-content button:hover { background-color: var(--bg-light); color: var(--primary-color); }
        .dropdown-content button:first-child { border-bottom: 1px solid #eee; }


        /* --- PAGINA√á√ÉO E MODAIS --- */
        .pagination-controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 25px; 
            padding: 15px 20px; 
            background-color: #fff3e0; 
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }
        .pagination-controls button {
            width: auto; 
            margin: 0; 
            padding: 10px 20px; 
            font-size: 0.9rem;
            background-color: var(--secondary-color);
        }
        
        /* Modal Style */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 30px;
            border-radius: 8px;
            width: 80%; 
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }


        /* --- RESPONSIVIDADE PARA CELULARES --- */
        @media (max-width: 768px) {
            
            .main-container { padding: 15px; }

            .header { flex-direction: column; align-items: flex-start; gap: 15px; padding-bottom: 10px; }
            .main-controls-group { flex-direction: row; justify-content: space-between; width: 100%; gap: 5px; }
            .user-info { order: 3; width: 100%; text-align: center; margin-top: 10px; }
            #logoutBtn { order: 2; width: auto; }
            .quick-actions { order: 1; }

            .dashboard-controls { flex-direction: column; gap: 15px; align-items: flex-start; }
            .filter-controls { width: 100%; justify-content: space-around; }
            .filter-controls button { flex-grow: 1; min-width: 100px; }
            
            .stats-cards { grid-template-columns: 1fr; gap: 10px; }

            .card-grid { grid-template-columns: 1fr; gap: 15px; }
            
            /* Ajuste de largura de bot√µes no mobile */
            .action-container { flex-direction: column; gap: 10px; }
            .action-container button:not(.dropbtn):not([disabled]),
            .dropdown { width: 100% !important; margin: 0; }
            .dropdown-content { min-width: 100%; }

            .pagination-controls { flex-direction: column; gap: 10px; }
            .pagination-controls button { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        
        <p id="loadingMessage" style="text-align: center; padding: 50px; color: var(--primary-color);">Verificando estado de autentica√ß√£o...</p> 

        <div id="loginSection" class="login-container" style="display: none;">
            <h2>Login da Distribuidora</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="input-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" id="loginBtn">Entrar</button>
                <p id="feedbackMessage" class="feedback-message" style="color: var(--danger-color); margin-top: 10px;"></p>
            </form>
        </div>

        <div id="dashboardSection" style="display: none;">
            <div class="header">
                <h1>üì¶ Gest√£o de Pedidos (E-commerce View)</h1>
                <div class="main-controls-group">
                    <span class="user-info">Ol√°, <strong id="userEmail" style="color: var(--primary-color);">admin</strong>!</span>
                    
                    <div class="quick-actions">
                        <a href="#" id="reportsLink" class="icon-btn" title="Relat√≥rios">üìä</a> 
                        <button id="priceBtn" class="icon-btn" title="Alterar Pre√ßo">‚öôÔ∏è</button>
                    </div>
                    
                    <button id="logoutBtn">Sair</button>
                </div>
            </div>

            <div class="stats-cards">
                <div class="stat-card total"><h3 title="Total de todos os pedidos">Total de Pedidos</h3><p id="totalCount">0</p></div>
                <div class="stat-card pendente"><h3 title="Aguardando confirma√ß√£o">Pendentes</h3><p id="pendenteCount">0</p></div>
                <div class="stat-card a-caminho"><h3 title="Saiu para entrega">A Caminho</h3><p id="aCaminhoCount">0</p></div>
                <div class="stat-card concluido"><h3 title="Entrega finalizada">Entregue</h3><p id="concluidoCount">0</p></div>
                <div class="stat-card cancelado"><h3 title="Cancelados por cliente ou admin">Cancelados</h3><p id="canceladoCount">0</p></div>
            </div>
            
            <div class="dashboard-controls">
                <div class="filter-controls">
                    <button id="showPendingBtn" class="control-button active-filter" style="background-color: var(--primary-color);">üî• Pendentes</button>
                    <button id="showEnRouteBtn" class="control-button" style="background-color: var(--info-color);">üöö A Caminho</button>
                    <button id="showCompletedBtn" class="control-button" style="background-color: var(--secondary-color);">‚úÖ Entregues</button>
                    <button id="showCancelledBtn" class="control-button" style="background-color: var(--secondary-color);">‚ùå Cancelados</button>
                </div>
            </div>
            
            <h2><span id="listTitle">üî• Pedidos Pendentes</span></h2>
            
            <div id="pedidosGrid" class="card-grid">
                <p style="grid-column: 1 / -1; text-align: center; color: var(--secondary-color);">Carregando pedidos...</p>
            </div>
            
            <div class="pagination-controls">
                <button id="prevPageBtn" disabled onclick="paginaAnterior()">
                    &larr; Anterior
                </button>
                <span id="pageInfo">P√°gina 1 de 1 (0 pedidos)</span>
                <button id="nextPageBtn" disabled onclick="proximaPagina()">
                    Pr√≥xima &rarr;
                </button>
            </div>
        </div>

    </div>

    <div id="priceModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('priceModal')">&times;</span>
            <h2>‚öôÔ∏è Alterar Pre√ßo Atual</h2>
            
            <form id="priceForm">
                <p style="margin-bottom: 20px;">Pre√ßo atual do G√°s: <strong id="currentPrice">R$ 0.00</strong></p>
                
                <div class="input-group">
                    <label for="newPrice">Novo Pre√ßo (R$)</label>
                    <input type="number" id="newPrice" step="0.01" min="1.00" required placeholder="Ex: 105.99">
                </div>
                
                <button type="submit" id="savePriceBtn">Salvar Novo Pre√ßo</button>
            </form>
        </div>
    </div>
    
  <script>
    // --- CONFIGURA√á√ÉO DO FIREBASE E INICIALIZA√á√ÉO ---
    const firebaseConfig = {
        // !!! Substitua aqui pelas SUAS credenciais !!!
        apiKey: "AIzaSyCgmVCXYByZINmC_TQGXf8j23khKolRp4I",
        authDomain: "gasapp-b48b1.firebaseapp.com",
        databaseURL: "https://gasapp-b48b1-default-rtdb.firebaseio.com",
        projectId: "gasapp-b48b1",
        storageBucket: "gasapp-b48b1.firebasestorage.app",
        messagingSenderId: "91157049244",
        appId: "1:91157049244:web:d84da8f96637958d1d2259",
        measurementId: "G-DW6NQ9NCEE"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database(); 
    
    // --- ESTADO GLOBAL DA APLICA√á√ÉO ---
    let todosOsPedidosCache = [];      // Armazena todos os pedidos brutos do Firebase
    let pedidosFiltradosGlobal = [];   // Armazena os pedidos ap√≥s a aplica√ß√£o do filtro
    let filtroAtual = 'pendentes';     // Filtro padr√£o
    const pedidosPorPagina = 12;      // Itens por p√°gina
    let paginaAtual = 1;               // P√°gina atual
    
    // --- MAPPINGS E AUXILIARES ---
    const STATUS_MAP = {
        pendente: 'Pendente',
        acaminho: 'A Caminho',
        entregue: 'Concluido',
        concluido: 'Concluido',
        cancelado: 'Cancelado',
    };
    const normalizeStatus = (status) => (status || 'Pendente').toLowerCase().replace(/\s/g, '').replace('√∫', 'u');
    
    // --- REFER√äNCIAS DOM ---
    let pedidosGrid, loginSection, dashboardSection, feedbackMessage, priceModal, priceForm;
    let showPendingBtn, showEnRouteBtn, showCompletedBtn, showCancelledBtn, prevPageBtn, nextPageBtn, pageInfoSpan;

    document.addEventListener('DOMContentLoaded', () => {
        // Inicializa√ß√£o de Refer√™ncias DOM
        pedidosGrid = document.getElementById('pedidosGrid');
        loginSection = document.getElementById('loginSection');
        dashboardSection = document.getElementById('dashboardSection');
        feedbackMessage = document.getElementById('feedbackMessage');
        priceModal = document.getElementById('priceModal');
        priceForm = document.getElementById('priceForm');
        
        showPendingBtn = document.getElementById('showPendingBtn');
        const showEnRouteBtn = document.getElementById('showEnRouteBtn'); // Mantido como const local
        showCompletedBtn = document.getElementById('showCompletedBtn');
        showCancelledBtn = document.getElementById('showCancelledBtn');

        prevPageBtn = document.getElementById('prevPageBtn');
        nextPageBtn = document.getElementById('nextPageBtn');
        pageInfoSpan = document.getElementById('pageInfo');
        
        // 1. L√ìGICA DE AUTENTICA√á√ÉO
        auth.onAuthStateChanged((user) => {
            document.getElementById('loadingMessage').style.display = 'none'; 
            if (user) {
                loginSection.style.display = 'none'; 
                dashboardSection.style.display = 'block'; 
                document.getElementById('userEmail').textContent = user.email;
                iniciarEscutasDoDashboard();

                // Atribui√ß√£o de Eventos de Filtros
                showPendingBtn.addEventListener('click', () => aplicarFiltro('pendentes'));
                showEnRouteBtn.addEventListener('click', () => aplicarFiltro('aCaminho'));
                showCompletedBtn.addEventListener('click', () => aplicarFiltro('concluidos'));
                showCancelledBtn.addEventListener('click', () => aplicarFiltro('cancelados'));
            } else {
                dashboardSection.style.display = 'none';
                loginSection.style.display = 'block'; 
            }
        });

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Aguarde...';
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(() => { 
                    feedbackMessage.textContent = "Erro no login: Email ou senha inv√°lidos.";
                    setTimeout(() => { feedbackMessage.textContent = ''; }, 5000);
                })
                .finally(() => { loginBtn.disabled = false; loginBtn.textContent = 'Entrar'; });
        }


        // 2. GEST√ÉO DE PRE√áO
        document.getElementById('priceBtn').addEventListener('click', () => openModal('priceModal'));
        priceForm.addEventListener('submit', handlePriceUpdate);

        function carregarPrecoAtual() {
            db.ref('config/preco_gas').on('value', (snapshot) => {
                let precoAtual = snapshot.exists() ? snapshot.val() : 0.00;
                const precoFormatadoBRL = parseFloat(precoAtual).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('currentPrice').textContent = precoFormatadoBRL;
                document.getElementById('newPrice').value = parseFloat(precoAtual).toFixed(2); 
            });
        }
        
        function handlePriceUpdate(e) {
            e.preventDefault();
            const novoPreco = parseFloat(document.getElementById('newPrice').value);
            
            if (novoPreco > 0) {
                db.ref('config').update({ preco_gas: novoPreco })
                .then(() => {
                    alert(`Pre√ßo atualizado para R$ ${novoPreco.toFixed(2).replace('.', ',')} com sucesso!`);
                    closeModal('priceModal');
                })
                .catch(error => {
                    alert("Erro ao salvar o pre√ßo: " + error.message);
                });
            } else {
                alert("Por favor, insira um pre√ßo v√°lido.");
            }
        }


        // 3. GEST√ÉO DE PEDIDOS (Escuta Principal)
        function iniciarEscutasDoDashboard() {
            carregarPrecoAtual(); 
            
            pedidosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--secondary-color);">Buscando dados no Firebase...</p>';
            
            db.ref('pedidos').on('value', (snapshot) => {
                todosOsPedidosCache = [];
                let contadores = { total: 0, pendentes: 0, aCaminho: 0, concluidos: 0, cancelados: 0 };

                snapshot.forEach((childSnapshot) => {
                    const pedidoData = childSnapshot.val();
                    pedidoData.id = childSnapshot.key; 
                    const status = normalizeStatus(pedidoData.status);
                    
                    contadores.total++;

                    if (status === 'pendente') { contadores.pendentes++; } 
                    else if (status.includes('caminho')) { contadores.aCaminho++; } 
                    else if (status === 'entregue' || status === 'concluido') { contadores.concluidos++; } 
                    else if (status === 'cancelado') { contadores.cancelados++; }

                    // Default values if missing
                    if (!pedidoData.email) pedidoData.email = 'N/A';
                    if (!pedidoData.tipoGas) pedidoData.tipoGas = 'P13';
                    if (!pedidoData.quantidade) pedidoData.quantidade = 1;

                    todosOsPedidosCache.push(pedidoData);
                });

                // Atualiza os Cards de Estat√≠sticas
                document.getElementById('totalCount').textContent = contadores.total;
                document.getElementById('pendenteCount').textContent = contadores.pendentes;
                document.getElementById('aCaminhoCount').textContent = contadores.aCaminho;
                document.getElementById('concluidoCount').textContent = contadores.concluidos;
                document.getElementById('canceladoCount').textContent = contadores.cancelados;

                paginaAtual = 1;
                aplicarFiltro(filtroAtual);
            });
        }
        
        // 4. FILTRAGEM E PAGINA√á√ÉO

        function aplicarFiltro(tipoFiltro) {
            filtroAtual = tipoFiltro;

            // 1. Atualiza√ß√£o Visual dos Filtros
            document.querySelectorAll('.filter-controls button').forEach(btn => btn.classList.remove('active-filter'));
            if (tipoFiltro === 'pendentes') document.getElementById('showPendingBtn').classList.add('active-filter');
            if (tipoFiltro === 'aCaminho') document.getElementById('showEnRouteBtn').classList.add('active-filter');
            if (tipoFiltro === 'concluidos') document.getElementById('showCompletedBtn').classList.add('active-filter');
            if (tipoFiltro === 'cancelados') document.getElementById('showCancelledBtn').classList.add('active-filter');

            const statusConcluidos = ['entregue', 'concluido'];
            const statusCancelados = ['cancelado'];
            let title = '';
            
            // 2. Filtragem dos Dados
            switch (tipoFiltro) {
                case 'pendentes':
                    pedidosFiltradosGlobal = todosOsPedidosCache.filter(p => normalizeStatus(p.status) === 'pendente');
                    title = 'üî• Pedidos Pendentes';
                    break;
                case 'aCaminho':
                    pedidosFiltradosGlobal = todosOsPedidosCache.filter(p => normalizeStatus(p.status).includes('caminho'));
                    title = 'üöö Pedidos A Caminho';
                    break;
                case 'concluidos':
                    pedidosFiltradosGlobal = todosOsPedidosCache.filter(p => statusConcluidos.includes(normalizeStatus(p.status)));
                    title = '‚úÖ Pedidos Conclu√≠dos';
                    break;
                case 'cancelados':
                    pedidosFiltradosGlobal = todosOsPedidosCache.filter(p => statusCancelados.includes(normalizeStatus(p.status)));
                    title = '‚ùå Pedidos Cancelados';
                    break;
            }
            
            document.getElementById('listTitle').textContent = title;

            // 3. Ordena√ß√£o (mais recente primeiro)
            pedidosFiltradosGlobal.sort((a, b) => new Date(b.dataPedido) - new Date(a.dataPedido));
            
            // 4. Renderiza a primeira p√°gina do novo filtro
            paginaAtual = 1;
            renderizarPaginaAtual();
        }

        function renderizarPaginaAtual() {
            pedidosGrid.innerHTML = ''; 
            const totalPedidos = pedidosFiltradosGlobal.length;
            const totalPaginas = Math.ceil(totalPedidos / pedidosPorPagina);

            if (totalPedidos === 0) {
                pedidosGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--secondary-color);">N√£o h√° pedidos na categoria "${document.getElementById('listTitle').textContent}" no momento.</p>`;
                pageInfoSpan.textContent = '0 pedidos';
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                return;
            }

            if (paginaAtual > totalPaginas) paginaAtual = totalPaginas;

            const indiceInicio = (paginaAtual - 1) * pedidosPorPagina;
            const indiceFim = indiceInicio + pedidosPorPagina;
            
            const pedidosParaRenderizar = pedidosFiltradosGlobal.slice(indiceInicio, indiceFim);
            
            pedidosParaRenderizar.forEach(renderizarCardPedido);

            pageInfoSpan.textContent = `P√°gina ${paginaAtual} de ${totalPaginas} (${totalPedidos} pedidos)`;
            prevPageBtn.disabled = paginaAtual <= 1;
            nextPageBtn.disabled = paginaAtual >= totalPaginas;
        }

        // Fun√ß√µes de navega√ß√£o (Globais)
        window.proximaPagina = function() {
            const totalPaginas = Math.ceil(pedidosFiltradosGlobal.length / pedidosPorPagina);
            if (paginaAtual < totalPaginas) {
                paginaAtual++;
                renderizarPaginaAtual();
            }
        }

        window.paginaAnterior = function() {
            if (paginaAtual > 1) {
                paginaAtual--;
                renderizarPaginaAtual();
            }
        }
        
        // --- 5. L√ìGICA DO WHATSAPP ---
        
        /**
         * Abre o WhatsApp do cliente com uma mensagem de que o pedido est√° a caminho.
         * @param {Object} pedido - O objeto do pedido com os dados do cliente e da compra.
         */
        function abrirWhatsappAvisoACaminho(pedido) {
            const whatsapp = pedido.whatsappCliente;
            const endereco = pedido.endereco || 'o endere√ßo cadastrado';
            const produto = `${pedido.quantidade || 1} x ${pedido.tipoGas || 'G√°s P13'}`;
            const valor = (pedido.valorTotal || 0).toFixed(2).replace('.', ',');
            
            const numeroLimpo = whatsapp ? whatsapp.replace(/\D/g, '') : null;
            
            if (!numeroLimpo || numeroLimpo.length < 10) {
                console.warn("N√∫mero de WhatsApp do cliente inv√°lido ou n√£o encontrado. Status alterado, mas n√£o foi poss√≠vel enviar a mensagem.");
                alert("Aten√ß√£o: N√∫mero de WhatsApp do cliente n√£o encontrado/inv√°lido. Status alterado, mas a mensagem autom√°tica n√£o foi enviada.");
                return;
            }
            
            const mensagem = `
Ol√°, ${pedido.email || 'Cliente'}!

Seu pedido #${pedido.id ? pedido.id.substring(1, 6) : 'N/A'} (Produto: ${produto}, Total: R$ ${valor}) **est√° a caminho**! üöö

Entrega no endere√ßo: ${endereco}

Aguarde o entregador! Agradecemos a prefer√™ncia.
            `.trim();

            const whatsappUrl = `https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(mensagem)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // Fun√ß√£o global para mudar o status (chamada pelo dropdown)
        window.mudarStatusPedido = function(pedidoId, novoStatus) {
            const statusParaSalvar = (novoStatus === 'Entregue') ? 'Concluido' : novoStatus;
            const isACaminho = statusParaSalvar.toLowerCase().includes('caminho');
            
            const confirmMessage = isACaminho 
                ? `Tem certeza que deseja mudar o pedido #${pedidoId.substring(1, 6)} para "${statusParaSalvar}" e abrir o WhatsApp para notificar o cliente?`
                : `Tem certeza que deseja mudar o pedido #${pedidoId.substring(1, 6)} para "${statusParaSalvar}"?`;


            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Busca o objeto completo do pedido na cache antes de atualizar
            const pedido = todosOsPedidosCache.find(p => p.id === pedidoId);
            
            db.ref(`pedidos/${pedidoId}`).update({ status: statusParaSalvar })
            .then(() => {
                // Se o status for 'A Caminho', chama a fun√ß√£o do WhatsApp
                if (isACaminho && pedido) {
                    abrirWhatsappAvisoACaminho(pedido); 
                }
                // N√£o precisa de alert de sucesso, pois a escuta do Firebase atualizar√° a UI automaticamente
            })
            .catch((error) => {
                alert("Erro ao atualizar o status: " + error.message);
            });
        }


        // 6. FUN√á√ÉO DE RENDERIZA√á√ÉO DO CARD
        function renderizarCardPedido(pedido) {
            const card = document.createElement('div');
            card.classList.add('pedido-card');
            
            const dataPedido = new Date(pedido.dataPedido);
            const dataFormatada = dataPedido.toLocaleDateString('pt-BR');
            const horaFormatada = dataPedido.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const statusNormalizado = normalizeStatus(pedido.status);
            const statusDisplay = STATUS_MAP[statusNormalizado] || 'Pendente';
            let statusClass = `status-${statusDisplay.replace(/\s/g, '')}`; 
            
            let borderColor = 'var(--primary-color)';
            if (statusNormalizado === 'pendente') borderColor = 'var(--warning-color)';
            else if (statusNormalizado.includes('caminho')) borderColor = 'var(--info-color)';
            else if (statusNormalizado === 'entregue' || statusNormalizado === 'concluido') borderColor = 'var(--success-color)';
            else if (statusNormalizado === 'cancelado') borderColor = 'var(--danger-color)';
            card.style.borderTopColor = borderColor;


            // HTML do Card 
            card.innerHTML = `
                <div class="card-header">
                    <h3>Pedido #${pedido.id ? pedido.id.substring(1, 6) : 'N/A'}</h3>
                    <span class="status ${statusClass}">${statusDisplay}</span>
                </div>

                <div class="client-info">
                    <p style="margin: 5px 0;">üë§ Cliente: ${pedido.email || 'Desconhecido'}</p>
                    <p style="margin: 5px 0;">üì± WhatsApp: <strong>${pedido.whatsappCliente || 'N/A'}</strong></p>
                </div>

                <div class="card-body">
                    <p><strong>Produto:</strong> ${pedido.tipoGas || 'P13'} (${pedido.quantidade || 1} unid)</p>
                    <p><strong>Total:</strong> R$ ${(pedido.valorTotal || 0).toFixed(2).replace('.', ',')}</p>
                    <p><strong>Pagamento:</strong> ${pedido.formaPagamento || 'N√£o Informado'}</p>
                    <p><strong>Hor√°rio:</strong> ${dataFormatada} ${horaFormatada}</p>
                </div>

                <div class="address-detail">
                    <p>üìç Endere√ßo: ${pedido.endereco || 'Endere√ßo n√£o informado'}</p>
                </div>

                <div class="action-container" id="actions-${pedido.id}">
                </div>
            `;
            
            const actionContainer = card.querySelector(`#actions-${pedido.id}`);

            if (statusNormalizado !== 'concluido' && statusNormalizado !== 'cancelado') {
                
                // BOT√ÉO R√ÅPIDO: "A Caminho" para pedidos pendentes
                if (statusNormalizado === 'pendente') {
                    const sendBtn = document.createElement('button');
                    sendBtn.innerHTML = 'üöö A Caminho';
                    sendBtn.style.backgroundColor = 'var(--info-color)'; 
                    sendBtn.onclick = (e) => { 
                        e.stopPropagation(); 
                        // Chama a fun√ß√£o mudarStatusPedido que far√° a atualiza√ß√£o e abrir√° o WhatsApp
                        mudarStatusPedido(pedido.id, 'A Caminho'); 
                    };
                    actionContainer.appendChild(sendBtn);
                }
                
                // Adiciona o Dropdown (que agora ocupa o restante do espa√ßo)
                const dropdown = createActionDropdown(pedido.id, statusNormalizado);
                actionContainer.appendChild(dropdown);
                
            } else {
                // Pedidos finalizados
                actionContainer.innerHTML = `<button disabled style="width:100%; background-color:#ccc; font-weight:500;">Status Finalizado</button>`;
                actionContainer.style.display = 'block'; 
            }

            pedidosGrid.appendChild(card);
        }

        function createActionDropdown(id, statusNormalizado) {
            const dropdown = document.createElement('div');
            dropdown.classList.add('dropdown');
            
            dropdown.onclick = function(event) { event.stopPropagation(); toggleDropdown(this); };

            const dropbtn = document.createElement('button');
            dropbtn.classList.add('dropbtn');
            dropbtn.innerHTML = 'Mais A√ß√µes ‚ñº'; 
            
            const dropdownContent = document.createElement('div');
            dropdownContent.classList.add('dropdown-content');

            // A√ß√µes no Dropdown
            if (statusNormalizado === 'pendente') {
                dropdownContent.appendChild(createActionButton('‚ùå Cancelar Pedido', id, 'Cancelado'));
            } else if (statusNormalizado.includes('caminho')) {
                dropdownContent.appendChild(createActionButton('‚úÖ Concluir Entrega', id, 'Entregue'));
                dropdownContent.appendChild(createActionButton('‚ùå Cancelar Pedido', id, 'Cancelado'));
            }

            dropdown.appendChild(dropbtn);
            dropdown.appendChild(dropdownContent);
            return dropdown;
        }

        function createActionButton(text, id, status) {
            const btn = document.createElement('button');
            btn.innerHTML = text;
            btn.onclick = (e) => { e.stopPropagation(); mudarStatusPedido(id, status); };
            return btn;
        }


        // 7. FUN√á√ïES AUXILIARES DE UI E EVENT LISTENERS

        window.toggleDropdown = function(element) {
            document.querySelectorAll(".dropdown-content.show-dropdown").forEach(openDropdown => {
                if (openDropdown !== element.querySelector(".dropdown-content")) {
                    openDropdown.classList.remove("show-dropdown");
                }
            });
            element.querySelector(".dropdown-content").classList.toggle("show-dropdown");
        }
        window.openModal = function(modalId) {
            document.getElementById(modalId).style.display = "block";
        }
        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        // Fechar dropdowns e modais clicando fora
        document.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                document.querySelectorAll(".dropdown-content.show-dropdown").forEach(openDropdown => {
                    openDropdown.classList.remove("show-dropdown");
                });
            }
            if (event.target == priceModal) closeModal('priceModal');
        }
    });
</script>
</body>
</html>